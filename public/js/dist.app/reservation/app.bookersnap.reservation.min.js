
var idMicrositio=obtenerIdMicrositio();angular.module('reservation.app',['promotion.app']).constant("IdMicroSitio",idMicrositio).constant("ApiUrlReservation","http://web.aplication.bookersnap/v1/en/admin/ms/"+idMicrositio+"/reservation");angular.module('promotion.app',['promotion.controller','promotion.service','promotion.directive']).config(function($stateProvider,$urlRouterProvider){$stateProvider.state('promotion',{url:'/promotion',templateUrl:'/js/app/reservation/promotion/view/index.html'}).state('add',{url:'/promotion/add',views:{'':{templateUrl:'/js/app/reservation/promotion/view/add.html'},'promotion@add':{templateUrl:'/js/app/reservation/promotion/view/promotion-add.html',controller:'PromotionAddCtrl',},'flyer@add':{templateUrl:'/js/app/reservation/promotion/view/flyer-add.html',controller:'FlyerAddCtrl',}}})});angular.module('promotion.controller',['ngFileUpload','ngImgCrop','textAngular','ngEmoticons','farbtastic','localytics.directives']).controller('PromotionCtrl',function($scope){}).controller('PromotionAddCtrl',function($scope,Upload,$timeout,$uibModal){$scope.titulo="Nueva promoción";$scope.estados=[{name:'Activo',value:1},{name:'Inactivo',value:0}];$scope.tipos=[{name:'Gratis',value:0},{name:'De pago',value:1}];$scope.zoneAvailable=[{id:1,title:'Zona01'},{id:2,title:'Zona02'},{id:3,title:'Zona03'},{id:4,title:'Zona04'}];$scope.promotion={caduca:false,tipo:0,estado:1,descripcion:" ",zonaselected:[2,3]};function modalInstances(){var modalInstance=$uibModal.open({templateUrl:'myModalContent.html',controller:'TurnoInstanceCtrl',});}
$scope.openModal=function(){modalInstances()}
$scope.today=function(){$scope.dt=new Date();};$scope.today();$scope.open=function($event,opened){$event.preventDefault();$event.stopPropagation();$scope[opened]=true;};$scope.dateOptions={formatYear:'yy',startingDay:1};$scope.formats=['dd-MMMM-yyyy','yyyy/MM/dd','dd.MM.yyyy','shortDate'];$scope.format=$scope.formats[0];$scope.myImage=undefined;$scope.croppedDataUrl='';$scope.imageCropStep=1;$scope.clear=function(){$scope.imageCropStep=1;delete $scope.myImage;delete $scope.croppedDataUrl;};$scope.uploadImage=function(file){Upload.upload({url:'http://web.aplication.bookersnap/v1/es/admin/ms/12/reservation/promotion/uploadfile',data:{file:file}}).then(function(resp){console.log('Success '+resp.config.data.file.name+' uploaded. Response: '+resp.data);},function(resp){console.log('Error status: '+resp.status);},function(evt){var progressPercentage=parseInt(100.0*evt.loaded/evt.total);console.log('progress: '+progressPercentage+'% '+evt.config.data.file.name);});};}).controller('FlyerAddCtrl',function($scope,Upload,PromotionFactory){$scope.titulo="Diseñar Flyer";$scope.textFlyer=[];$scope.textActive=false;$scope.textIndex=0;PromotionFactory.getLabel().success(function(data){var vTexto=[];angular.forEach(data,function(zones){vTexto.push(zones);});$scope.flyer.labels=vTexto;});$scope.flyer={fonts:[{id:'Arial',title:'Arial'},{id:'Lobster',title:'Lobster'},{id:'Roboto',title:'Roboto'}],fontSelected:{id:'Arial',title:'Arial'},sizes:[{id:10,valor:'10px'},{id:12,valor:'12px'},{id:14,valor:'14px'}],sizeSelected:{id:14,valor:'14px'},colorSelected:{color:'#03A9F4'},states:[{name:'Activo',value:1},{name:'Inactivo',value:0}],stateSelected:{value:1}}
$scope.addText=function(){if($scope.flyer.labelSelected){var texto={label:$scope.flyer.labelSelected,tipografy:$scope.flyer.fontSelected.id,font_size:$scope.flyer.sizeSelected.id+"px",color:$scope.flyer.colorSelected.color};$scope.textFlyer.push(texto);cleanText();}else{messageAlert("Flyer","Debe seleccionar un texto","warning");}}
$scope.selectedText=function(index){$scope.textIndex=index;$scope.flyer.labelSelected=$scope.textFlyer[index].label;$scope.flyer.fontSelected={id:$scope.textFlyer[index].tipografy,title:$scope.textFlyer[index].tipografy};$scope.flyer.sizeSelected.id=$scope.textFlyer[index].font_size.replace("px","");$scope.flyer.colorSelected.color=$scope.textFlyer[index].color;$scope.textActive=true;}
$scope.updateText=function(){$scope.textFlyer[$scope.textIndex].label=$scope.flyer.labelSelected;$scope.textFlyer[$scope.textIndex].tipografy=$scope.flyer.fontSelected.id;$scope.textFlyer[$scope.textIndex].font_size=$scope.flyer.sizeSelected.id+"px";$scope.textFlyer[$scope.textIndex].color=$scope.flyer.colorSelected.color;$scope.textActive=false;cleanText();}
$scope.deleteText=function(){$scope.textFlyer.splice($scope.textIndex,1);$scope.textActive=false;cleanText();}
var cleanText=function(){$scope.flyer.label="";$scope.flyer.fontSelected={id:'Arial',title:'Arial'};$scope.flyer.sizeSelected={id:14,valor:'14px'};$scope.flyer.colorSelected={color:'#03A9F4'};}
$scope.clearImageFlyer=function(){delete $scope.coleccion.fileimg;};$scope.generateFlyer=function(){html2canvas(angular.element('.svgArea'),{onrendered:function(canvas){theCanvas=canvas;Canvas2Image.convertToPNG(canvas);document.body.appendChild(canvas);}});}
$scope.saveFlyer=function(){angular.forEach($scope.textFlyer,function(data,index){data.coodinates={x:angular.element('.text-flyer').eq(index).css("left"),y:angular.element('.text-flyer').eq(index).css("top")}})
$scope.principal={"microsite_id":1,"event_id":1,"token":"abc123456","status":$scope.flyer.stateSelected.value,"image":$scope.coleccion.fileimg.name,"label":$scope.textFlyer};console.log("General  "+angular.toJson($scope.principal,true));}}).controller('TurnoInstanceCtrl',function($scope,$modalInstance){$scope.semana=[{id:1,nameday:'Domingo'},{id:2,nameday:'Lunes'},{id:3,nameday:'Martes'},{id:4,nameday:'Miercoles'},{id:5,nameday:'Jueves'},{id:6,nameday:'Viernes'},{id:7,nameday:'Sabado'}];$scope.activityAvailable=[{ida:1,title:'Reservacion'},{ida:2,title:'Comida'},{ida:3,title:'Cena'},{ida:4,title:'Bar noche'}];$scope.ok=function(){$modalInstance.close();};$scope.cancel=function(){$modalInstance.dismiss('cancel');};});angular.module('promotion.directive',[]).directive('ngDraggable',function($document,$window){function makeDraggable(scope,element,attr){var startX=0;var startY=0;var x=Math.floor((Math.random()*300)+40);var y=Math.floor((Math.random()*300)+40);element.css({position:'absolute',cursor:'pointer',top:y+'px',left:x+'px'});element.on('mousedown',function(event){event.preventDefault();startX=event.pageX-x;startY=event.pageY-y;$document.on('mousemove',mousemove);$document.on('mouseup',mouseup);});function mousemove(event){y=event.pageY-startY;x=event.pageX-startX;element.css({top:y+'px',left:x+'px'});}
function mouseup(){$document.unbind('mousemove',mousemove);$document.unbind('mouseup',mouseup);}}
return{link:makeDraggable};});angular.module('promotion.service',[]).factory('PromotionFactory',function($http,ApiUrlReservation){return{getLabel:function(vData){return $http.get(ApiUrlReservation+"/promotion/getlabel");}};});angular.module('bookersnap',['reservation.app']);