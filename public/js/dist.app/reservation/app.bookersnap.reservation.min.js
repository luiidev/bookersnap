
var idMicrositio=obtenerIdMicrositio();angular.module('reservation.app',['promotion.app']).constant("IdMicroSitio",idMicrositio).constant("ApiUrlReservation","http://web.aplication.bookersnap/v1/en/admin/ms/"+idMicrositio+"/reservation").constant("ApiUrlGeneral","http://192.168.0.107/api.promociones/public/v1/es");angular.module('promotion.app',['promotion.controller','promotion.service','promotion.directive','promotion.filter']).config(function($stateProvider,$urlRouterProvider,$httpProvider){$stateProvider.state('promotion',{url:'/promotion',templateUrl:'/js/app/reservation/promotion/view/index.html',controller:'PromotionCtrl',}).state('add',{url:'/promotion/add',views:{'':{templateUrl:'/js/app/reservation/promotion/view/add.html'},'promotion@add':{templateUrl:'/js/app/reservation/promotion/view/promotion-add.html',controller:'PromotionAddCtrl',},'flyer@add':{templateUrl:'/js/app/reservation/promotion/view/flyer-add.html',controller:'FlyerAddCtrl',}}});});angular.module('promotion.controller',['ngFileUpload','ngImgCrop','textAngular','ngEmoticons','farbtastic','localytics.directives']).controller('PromotionCtrl',function($scope){$scope.titulo="Promociones";}).controller('PromotionAddCtrl',function($scope,Upload,$timeout,$uibModal,PromotionFactory,TurnosPromotionFactory){$scope.titulo="Nueva promoción";PromotionFactory.getTypes().success(function(data){var vTypes=[];angular.forEach(data['data'],function(types){vTypes.push(types);});$scope.promotion.tipos=vTypes;$scope.promotion.tipoSelected=$scope.promotion.tipos[0];});$scope.promotion={estados:[{name:'Activo',value:1},{name:'Inactivo',value:0}],estadoSelected:{value:1},descripcion:" ",zonas:[{id:1,title:'Zona01'},{id:2,title:'Zona02'},{id:3,title:'Zona03'},{id:4,title:'Zona04'}],zonaSelected:[2,3],caduca:false,publica:true,myImage:undefined};$scope.cropped={cropWidth:100,cropHeight:100,cropTop:0,cropLeft:10}
$scope.addCroppingWatcher=function(){console.log('hecho');}
$scope.validarImg=function(file){if(file==null){messageAlert("Flyer","Seleccione imagen mayor a 300px x 300px","warning");delete $scope.promotion.myImage;}}
$scope.modalContent=TurnosPromotionFactory.getTurnosItems();$scope.savePromotion=function(){uploadImage($scope.promotion.myImage);uploadImage64($scope.croppedDataUrl);$scope.datosPromotion={"microsite_id":1,"event_id":1,"token":"abc123456","titulo":$scope.promotion.titulo,"description":$scope.promotion.descripcion,"status_expire":$scope.promotion.caduca,"date_expire":$scope.promotion.fecha_caduca,"publica":$scope.promotion.publica,"tipo":$scope.promotion.tipoSelected.value,"status":$scope.promotion.estadoSelected.value,"image":cleanString($scope.promotion.myImage.name)};console.log('Guardando'+angular.toJson($scope.datosPromotion,true));console.log(TurnosPromotionFactory.getTurnosItems());}
function modalInstances(animation,size,backdrop,keyboard){var modalInstance=$uibModal.open({animation:animation,templateUrl:'myModalContent.html',controller:'TurnoInstanceCtrl',size:size,resolve:{content:function(){return $scope.modalContent;}}});}
$scope.openModal=function(size){modalInstances(true,size,true,true)}
$scope.today=function(){$scope.dt=new Date();};$scope.today();$scope.open=function($event,opened){$event.preventDefault();$event.stopPropagation();$scope[opened]=true;};$scope.dateOptions={formatYear:'yy',startingDay:1};$scope.formats=['dd-MMMM-yyyy','yyyy/MM/dd','dd.MM.yyyy','shortDate'];$scope.format=$scope.formats[0];$scope.myImage=undefined;$scope.croppedDataUrl='';$scope.imageCropStep=1;$scope.clearImagePromotion=function(){delete $scope.promotion.myImage;delete $scope.croppedDataUrl;};var uploadImage=function(file){Upload.upload({url:'http://web.aplication.bookersnap/v1/es/admin/ms/12/reservation/promotion/uploadfile',data:{file:file}}).then(function(resp){console.log('Success '+resp.config.data.file.name+' uploaded. Response: '+resp.data);},function(resp){console.log('Error status: '+resp.status);},function(evt){var progressPercentage=parseInt(100.0*evt.loaded/evt.total);console.log('progress: '+progressPercentage+'% '+evt.config.data.file.name);});};var uploadImage64=function(file){Upload.upload({url:'http://web.aplication.bookersnap/v1/es/admin/ms/12/reservation/promotion/uploadfile64',data:{file:file}}).then(function(resp){console.log(resp);},function(resp){console.log('Error status: '+resp.status);},function(evt){var progressPercentage=parseInt(100.0*evt.loaded/evt.total);console.log('progress: '+progressPercentage+'% '+evt.config.data.file.name);});}
$scope.invocarZonas=function(item){alert(item);}}).controller('FlyerAddCtrl',function($scope,Upload,PromotionFactory){$scope.titulo="Diseñar Flyer";$scope.textFlyer=[];$scope.textActive=false;$scope.textIndex=0;PromotionFactory.getLabel().success(function(data){var vTexto=[];angular.forEach(data['data'],function(label){vTexto.push(label);});$scope.flyer.labels=vTexto;$scope.flyer.labelSelected=$scope.flyer.labels[0];});PromotionFactory.getTypographys().success(function(data){var vTipography=[];angular.forEach(data['data'],function(tipography){vTipography.push(tipography);});$scope.flyer.fonts=vTipography;$scope.flyer.fontSelected=$scope.flyer.fonts[0];});$scope.flyer={sizes:[{id:10,valor:'10px'},{id:12,valor:'12px'},{id:14,valor:'14px'}],sizeSelected:{id:14,valor:'14px'},colorSelected:{color:'#03A9F4'},}
$scope.addText=function(){if($scope.flyer.labelSelected){if($scope.textFlyer.length==0){crearTexto();}else{var exists=false;angular.forEach($scope.textFlyer,function(objetos){if($scope.flyer.labelSelected.label_id==objetos.label.label_id){exists=true;messageAlert("Flyer","Texto ya se encuentra ubicado sobre el flyer","warning");}});if(exists===false){crearTexto();}}}else{messageAlert("Flyer","Debe seleccionar un texto","warning");}}
var crearTexto=function(){var texto={label:$scope.flyer.labelSelected,typography:{typography_id:$scope.flyer.fontSelected.typography_id,name:$scope.flyer.fontSelected.name},font_size:$scope.flyer.sizeSelected.id+"px",color:$scope.flyer.colorSelected.color};$scope.textFlyer.push(texto);cleanText();}
$scope.changeFunction=function(){$scope.textActive=false;}
$scope.selectedText=function(index){$scope.textIndex=index;$scope.flyer.labelSelected=$scope.textFlyer[index].label;$scope.flyer.fontSelected={typography_id:$scope.textFlyer[index].typography.typography_id,name:$scope.textFlyer[index].typography.name};$scope.flyer.sizeSelected.id=$scope.textFlyer[index].font_size.replace("px","");$scope.flyer.colorSelected.color=$scope.textFlyer[index].color;$scope.textActive=true;}
$scope.autoPropiedad=function(){if($scope.textFlyer.length!=0){$scope.textFlyer[$scope.textIndex].font_size=$scope.flyer.sizeSelected.id+"px";$scope.textFlyer[$scope.textIndex].color=$scope.flyer.colorSelected.color;$scope.textFlyer[$scope.textIndex].typography={typography_id:$scope.flyer.fontSelected.typography_id,name:$scope.flyer.fontSelected.name};}};$scope.deleteText=function(){$scope.textFlyer.splice($scope.textIndex,1);$scope.textActive=false;cleanText();}
var cleanText=function(){$scope.flyer.labelSelected=$scope.flyer.labels[0];}
$scope.noEditar=function(){$scope.textActive=false;cleanText();}
$scope.existeFlyer=false;$scope.uploadImageFlyer=function(file){$scope.temporal=file;$scope.existeFlyer=true;};var uploadFile=function(file){Upload.upload({url:'http://web.aplication.bookersnap/v1/es/admin/ms/12/reservation/promotion/uploadfile',data:{file:file}}).then(function(resp){console.log('Success '+resp.config.data.file.name+' uploaded. Response: '+resp.data);},function(resp){console.log('Error status: '+resp.status);},function(evt){var progressPercentage=parseInt(100.0*evt.loaded/evt.total);console.log('progress: '+progressPercentage+'% '+evt.config.data.file.name);});}
var uploadFile64=function(file){Upload.upload({url:'http://web.aplication.bookersnap/v1/es/admin/ms/12/reservation/promotion/uploadfile64',data:{file:file}}).then(function(resp){console.log(resp);},function(resp){console.log('Error status: '+resp.status);},function(evt){var progressPercentage=parseInt(100.0*evt.loaded/evt.total);console.log('progress: '+progressPercentage+'% '+evt.config.data.file.name);});}
$scope.clearImageFlyer=function(){delete $scope.coleccion.fileimg;};var generateFlyer=function(){html2canvas(angular.element('.svgArea'),{onrendered:function(canvas){theCanvas=canvas;var img=canvas.toDataURL("image/png");document.body.appendChild(canvas);}});}
$scope.saveFlyer=function(){if($scope.existeFlyer){angular.forEach($scope.textFlyer,function(data,index){data.coodinates={x:angular.element('.text-flyer').eq(index).css("left"),y:angular.element('.text-flyer').eq(index).css("top")}})
uploadFile($scope.coleccion.fileimg);generateFlyer();$scope.principal={"microsite_id":1,"event_id":1,"token":"abc123456","image":cleanString($scope.coleccion.fileimg.name),"label":$scope.textFlyer};console.log("General  "+angular.toJson($scope.principal,true));messageAlert("Flyer","Se ha adjuntado correctamente el flyer","success");}else{messageAlert("Flyer","Debe seleccionar una imagen para el flyer","warning");};}}).controller('TurnoInstanceCtrl',function($scope,$modalInstance,$filter,TurnosPromotionFactory,content){$scope.listTurnos=content;$scope.turnoIndex=0;var cantidad=$scope.listTurnos.length;if(cantidad>0){$scope.existeTurno=true;}else{$scope.existeTurno=false;}
$scope.turnos={actividades:[{id:1,name:'Reservacion'},{id:2,name:'Comida'},{id:3,name:'Cena'},{id:4,name:'Bar noche'},],semana:[{id:0,label:'Domingo',disabled:false,checked:false},{id:1,label:'Lunes',disabled:false,checked:false},{id:2,label:'Martes',disabled:false,checked:false},{id:3,label:'Miercoles',disabled:false,checked:false},{id:4,label:'Jueves',disabled:false,checked:false},{id:5,label:'Viernes',disabled:false,checked:false},{id:6,label:'Sabado',disabled:false,checked:false},],actividadSelected:{id:1,name:'Reservacion'},turnoSelected:[],hours_ini:'',hours_end:'',disposiciones:[{id:1,name:'Aplicar siempre'},{id:2,name:'Añadir turno a la promocion'}],disposicionSelected:{id:1,name:'Aplicar siempre'},};$scope.horarios={hour_ini:'',hour_end:''};var getDaysSelected=function(days){var daysData=[];angular.forEach(days,function(data,key){if(data){daysData.push({day:key});}});return daysData;};$scope.addTurno=function(){var cantidadSel=$scope.turnos.turnoSelected.length;if(cantidadSel>0){if($scope.horarios.hour_ini!=""&&$scope.horarios.hour_end!=""){var days=getDaysSelected($scope.turnos.turnoSelected);$scope.turnoSelected=days;$scope.turnos.hours_ini=$filter('date')($scope.horarios.hour_ini,'HH:mm:ss');$scope.turnos.hours_end=$filter('date')($scope.horarios.hour_end,'HH:mm:ss');$scope.actividadSelected=$scope.turnos.actividadSelected;var opciones={actividad:$scope.actividadSelected,dias:$scope.turnoSelected,hinicio:$scope.turnos.hours_ini,hfinal:$scope.turnos.hours_end,};TurnosPromotionFactory.setTurnosItems(opciones);$scope.existeTurno=true;cleanTurno();console.log($scope.listTurnos);}else{messageAlert("Turnos","Debe seleccionar campos de hora","warning");}}else{messageAlert("Turnos","Debe seleccionar al menos un dia de la semana","warning");}};$scope.deleteTurno=function(item){$scope.turnoIndex=item;TurnosPromotionFactory.delTurnosItem($scope.turnoIndex);cleanTurno();};var cleanTurno=function(){$scope.horarios.hour_ini='';$scope.horarios.hour_end='';$scope.turnos.turnoSelected=[];}
$scope.cancel=function(){$modalInstance.dismiss('cancel');};});angular.module('promotion.directive',[]).directive('ngDraggable',function($document,$window){function makeDraggable(scope,element,attr){var startX=0;var startY=0;var x=Math.floor((Math.random()*300)+40);var y=Math.floor((Math.random()*200)+40);element.css({position:'absolute',cursor:'pointer',top:y+'px',left:x+'px'});element.on('mousedown',function(event){event.preventDefault();startX=event.pageX-x;startY=event.pageY-y;$document.on('mousemove',mousemove);$document.on('mouseup',mouseup);});function mousemove(event){y=event.pageY-startY;x=event.pageX-startX;element.css({top:y+'px',left:x+'px'});}
function mouseup(){$document.unbind('mousemove',mousemove);$document.unbind('mouseup',mouseup);}}
return{link:makeDraggable};}).directive('ngSelectTable',function(){function makeSelectTable(scope,element,attr){var left=attr.x;var top=attr.y;element.css({position:'absolute',cursor:'pointer',top:top+'px',left:left+'px',});element.on('click',function(event){event.preventDefault();scope.onClickFn();if(this.classList.contains('selected-table')){this.classList.remove('selected-table');}else{this.classList.add('selected-table');}});}
return{link:makeSelectTable,scope:{onClickFn:'&'}};})
angular.module('promotion.filter',[]).filter("maxLength",function(){return function(text,max){if(text!=null){if(text.length>max){return"Texto a mostrar en el portal: <span class='text-red'>"+text.substring(3,max)+"</span>";}}}}).filter("toUpper",function(){return function(text){if(text!=null){return text.toUpperCase();}}}).filter("diaSemana",function(){return function(num){if(num!=null){var day="";switch(num){case 0:day="Domingo";break;case 1:day="Lunes";break;case 2:day="Martes";break;case 3:day="Miercoles";break;case 4:day="Jueves";break;case 5:day="Viernes";break;case 6:day="Sabado";break;}
return day;}}})
angular.module('promotion.service',[]).factory('PromotionFactory',function($http,ApiUrlReservation,ApiUrlGeneral){return{getLabel:function(vData){return $http.get(ApiUrlReservation+"/promotion/getlabel");},getTypes:function(vData){return $http.get(ApiUrlReservation+"/promotion/gettypes");},getTypographys:function(vData){return $http.get(ApiUrlReservation+"/promotion/gettypographys");}};}).factory('TurnosPromotionFactory',function(){var turnoColection=[];var interfazTurnos={nombre:"turnos",getTurnosItems:function(){return turnoColection;},setTurnosItems:function(turnoItem){turnoColection.push(turnoItem);},delTurnosItem:function(turnoItem){turnoColection.splice(turnoItem,1);},cleanTurnosItems:function(){turnoColection=[];},}
return interfazTurnos;});angular.module('bookersnap',['tables.app','reservation.app']);