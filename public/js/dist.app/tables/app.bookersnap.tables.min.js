
var idMicrositio=obtenerIdMicrositio();angular.module('tables.app',['turn.app','zone.app']).constant("IdMicroSitio",idMicrositio).constant("ApiUrl",'http://web.aplication.bookersnap/v1/en/admin/ms/'+idMicrositio+'/mesas');angular.module('turn.app',['turn.controller','turn.service','turn.directive']).config(function($stateProvider,$urlRouterProvider){$stateProvider.state('turn',{url:'/config/turn',templateUrl:'/js/app/tables/turn/view/index.html'}).state('turn.active',{url:'/turn-active',templateUrl:'/js/app/tables/turn/view/turn-active.html'}).state('turn.inactive',{url:'/turn-inactive',templateUrl:'/js/app/tables/turn/view/turn-inactive.html'}).state('turn-create',{url:'/config/turn/new',templateUrl:'/js/app/tables/turn/view/turn-create.html'}).state('turn-edit',{url:'/config/turn/edit',templateUrl:'/js/app/tables/turn/view/turn-edit.html'})});angular.module('turn.controller',[]).controller('TurnCtrl',function($scope){}).controller('TurnCreateCtrl',function($scope){});angular.module('turn.directive',[]);angular.module('turn.service',[]);angular.module('zone.app',['zone.controller','zone.service','zone.directive']).config(function($stateProvider,$urlRouterProvider){$stateProvider.state('zone',{url:'/config/zone',templateUrl:'/js/app/tables/zone/view/index.html'}).state('zone.active',{url:'/zone-active',templateUrl:'/js/app/tables/zone/view/zone-active.html'}).state('zone.inactive',{url:'/zone-inactive',templateUrl:'/js/app/tables/zone/view/zone-inactive.html'}).state('zone-create',{url:'/config/zone/new',templateUrl:'/js/app/tables/zone/view/zone-create.html'}).state('zone-edit',{url:'/config/zone/:id',templateUrl:'/js/app/tables/zone/view/zone-edit.html'}).state('zone-clone',{url:'/config/zone/:id/clone',templateUrl:'/js/app/tables/zone/view/zone-clone.html'})});angular.module('zone.controller',['ngDraggable']).controller('ZoneCtrl',function($scope,ZoneFactory,$uibModal){$scope.zonesActive={};$scope.zonesInactive={};$scope.idZoneDelete=0;$scope.indexRow=0;$scope.getZones=function(){ZoneFactory.getZones().success(function(data){var vZonesActive=[];var vZonesInactive=[];angular.forEach(data,function(zones){var zonesTables=getTablesCount(zones);if(zones.status=="0"||zones.status=="2"){vZonesInactive.push(zonesTables);}else{vZonesActive.push(zonesTables);}});$scope.zonesActive=vZonesActive;$scope.zonesInactive=vZonesInactive;});};$scope.deleteZoneConfirm=function(idZone,indexRow){$scope.idZoneDelete=idZone;$scope.indexRow=indexRow;console.log("indexRow "+indexRow);var modalDeleteZone=$uibModal.open({animation:true,templateUrl:'myModalDeleteZone.html',size:'lg',controller:'ModalZoneDeleteCtrl',resolve:{idZone:function(){return $scope.idZoneDelete;},indexRow:function(){return $scope.indexRow;},zonesInactive:function(){return $scope.zonesInactive;}}});};var getTablesCount=function(zones){var vTables=0;angular.forEach(zones.tables,function(tables){vTables+=1;});zones.tables_count=vTables;return zones;};$scope.getZones();}).controller('ZoneCreateCtrl',function($scope,$stateParams,$document,ZoneFactory,ZoneLienzoFactory,TableFactory,$uibModal,IdMicroSitio){$scope.sizeTableList={data:[{id:"1",label:"small"},{id:"2",label:"medium"},{id:"3",label:"large"}],selectedOption:{id:"1",label:"small"}}
$scope.coversList={dataMin:[],selectedMin:'',dataMax:[],selectedMax:''}
$scope.headerZone={tables:0,minCovers:0,maxCovers:0}
$scope.itemTables=[];$scope.boxTables={items:true,item:false}
$scope.typeDrag="";$scope.indexTable=null;$scope.selectedTable=false;this.alertaPrueba=function(){};$scope.onDragComplete=function(data,evt,type){$scope.typeDrag=type;selectTableTypeDrag(data,type);};$scope.onDropComplete=function(data,evt){data.top=evt.y-261+25-evt.element.centerY;data.left=evt.x-61+25-evt.element.centerX;console.log("onDropComplete "+evt.x+" - "+evt.y);selectTableTypeDrop(data);$scope.typeDrag="";};$scope.onLienzo=function(){if($scope.indexTable!=null&&$scope.selectedTable==false){console.log("onLienzo");$scope.activarTablesItems();}
$scope.selectedTable=false;};$scope.changeShapeTable=function(shape){$scope.itemTables[$scope.indexTable].shape=shape;angular.element(".text-rotate .btn-group .shape").removeClass("active");angular.element(".shape."+shape+"s").addClass("active");};$scope.changeSizeTable=function(){$scope.itemTables[$scope.indexTable].size=$scope.sizeTableList.selectedOption.label;};$scope.editNameTable=function(){$scope.itemTables[$scope.indexTable].name=angular.element("#name-table").val();};$scope.tableCapacity=function(option){if(option=="min"){$scope.itemTables[$scope.indexTable].minCover=$scope.coversList.selectedMin.id;}else{$scope.itemTables[$scope.indexTable].maxCover=$scope.coversList.selectedMax.id;}
if($scope.coversList.selectedMax.id<$scope.coversList.selectedMin.id){$scope.itemTables[$scope.indexTable].minCover=$scope.coversList.selectedMax.id;$scope.itemTables[$scope.indexTable].maxCover=$scope.coversList.selectedMax.id;getDataTableSelected($scope.indexTable);}
updateHeaderZone();};$scope.rotateShapeTable=function(){console.log("rotateShapeTable ",$scope.itemTables[$scope.indexTable].rotate);if($scope.itemTables[$scope.indexTable].rotate=="0"){$scope.itemTables[$scope.indexTable].rotate="45";}else{$scope.itemTables[$scope.indexTable].rotate="0";}};$scope.activarTableOptions=function(index,vthis){$scope.selectedTable=true;getDataTableSelected(index);$scope.$apply(function(){if($scope.boxTables.item==false){$scope.boxTables.item=true;$scope.boxTables.items=false;}else{$scope.boxTables.item=false;$scope.boxTables.items=true;}});};$scope.doneTableSelected=function(){$scope.activarTablesItems();};var listCovers=function(option){var coverList="";if(option=="min"){coverList=$scope.coversList.dataMin;}else{coverList=$scope.coversList.dataMax;}
for(var i=1;i<=30;i++){var data={label:i+" covers",id:i}
coverList.push(data);}
if(option=="min"){$scope.coversList.selectedMin=coverList[0];}else{$scope.coversList.selectedMax=coverList[0];}};var getDataTableSelected=function(index){$scope.indexTable=index;angular.element("#name-table").val($scope.itemTables[index].name);$scope.changeShapeTable($scope.itemTables[index].shape);$scope.itemTables[index].top=angular.element("#tb-item"+index).css("top").replace("px","");$scope.itemTables[index].left=angular.element("#tb-item"+index).css("left").replace("px","");$scope.coversList.selectedMin={id:$scope.itemTables[$scope.indexTable].minCover,label:$scope.itemTables[$scope.indexTable].minCover+" covers"};$scope.coversList.selectedMax={id:$scope.itemTables[$scope.indexTable].maxCover,label:$scope.itemTables[$scope.indexTable].maxCover+" covers"};$scope.sizeTableList.selectedOption={id:TableFactory.getIdSize($scope.itemTables[index].size),label:$scope.itemTables[index].size};};$scope.activarTablesItems=function(){ZoneLienzoFactory.activarTablesItems($scope.boxTables);};$scope.deleteSelectTableItem=function(){var modalDeleteTable=$uibModal.open({animation:true,templateUrl:'myModalDeleteTable.html',size:'lg',controller:'ModalTableDeteleCtrl',resolve:{itemTables:function(){return $scope.itemTables;},indexTable:function(){return $scope.indexTable;},boxTables:function(){return $scope.boxTables;},headerZone:function(){return $scope.headerZone;}}});};var selectTableTypeDrag=function(data){var index=$scope.itemTables.indexOf(data);if(index>-1){$scope.itemTables.splice(index,1);}};var selectTableTypeDrop=function(data){var index=$scope.itemTables.indexOf(data);if(index==-1)
$scope.itemTables.push(data);updateHeaderZone();};var updateHeaderZone=function(){ZoneLienzoFactory.updateHeaderZone($scope.headerZone,$scope.itemTables);};$scope.saveZone=function(option){var dataZone={name:angular.element("#zone_name").val(),ms_microsite_id:IdMicroSitio,tables:[]}
angular.forEach($scope.itemTables,function(table){var tableItem={name:table.name,min_cover:table.minCover,max_cover:table.maxCover,config_position:table.left+","+table.top,config_size:TableFactory.getIdSize(table.size),config_rotation:table.rotate,config_forme:TableFactory.getIdShape(table.shape)}
dataZone.tables.push(tableItem);});if(option=="create"){ZoneFactory.createZone(dataZone).success(function(response){console.log("succes createZone "+JSON.stringify(response));messageAlert("Success","Zone create complete","success");});}else{ZoneFactory.editZone(dataZone).success(function(response){console.log("succes editZone "+JSON.stringify(response));messageAlert("Success","Zone edit complete","success");});}
console.log("saveZone "+JSON.stringify(dataZone));};var detectedForm=function(){if($stateParams.id!=undefined){console.log("params edit",$stateParams.id);var Zone=ZoneFactory.getZone($stateParams.id).success(function(zone){angular.element("#zone_name").val(zone.name);loadTablesEdit(zone.tables)});}};var loadTablesEdit=function(tables){angular.forEach(tables,function(data){var position=data.config_position.split(",");var dataTable={name:data.name,minCover:data.min_cover,maxCover:data.max_cover,left:position[0],top:position[1],shape:TableFactory.getLabelShape(data.config_forme),size:TableFactory.getLabelSize(data.config_size),rotate:data.config_rotation}
$scope.itemTables.push(dataTable);});updateHeaderZone();};detectedForm();listCovers("min");listCovers("max");}).controller('ModalTableDeteleCtrl',function($scope,$uibModalInstance,itemTables,indexTable,boxTables,headerZone,ZoneLienzoFactory){$scope.ok=function(){ZoneLienzoFactory.activarTablesItems(boxTables);itemTables.splice(indexTable,1);angular.element('.item-drag-table').removeClass('selected-table');ZoneLienzoFactory.updateHeaderZone(headerZone,itemTables);$uibModalInstance.close();};$scope.cancel=function(){$uibModalInstance.dismiss('cancel');};}).controller('ModalZoneDeleteCtrl',function($scope,ZoneFactory,$uibModalInstance,idZone,indexRow,zonesInactive){$scope.deleteZone=function(){ZoneFactory.deleteZone(idZone).success(function(response){console.log("deleteZone msg "+response);zonesInactive.splice(indexRow,1);$uibModalInstance.close();});};$scope.cancel=function(){$uibModalInstance.dismiss('cancel');};});angular.module('zone.directive',[]).directive('ngDragTable',function($document,$window){function makeDraggable(scope,element,attr,ctrl){var startX=0;var startY=0;var x=0;var y=0;setTimeout(function(){x=element.attr("left");y=element.attr("top");},200);element.attr("top",y);element.attr("left",x);element.on('mousedown',function(event){event.preventDefault();startX=event.pageX-x;startY=event.pageY-y;$document.on('mousemove',mousemove);$document.on('mouseup',mouseup);});element.on('click',function(event){event.preventDefault();scope.onClickFn();if(this.classList.contains('selected-table')){this.classList.remove('selected-table');}else{angular.element('.item-drag-table').removeClass('selected-table');this.classList.add('selected-table');}})
function mousemove(event){var limitLienzo=getLimitLienzo(element.attr("shape"),element.attr("size"),element.attr("rotate"));var tmp_y=event.pageY-startY;var tmp_x=event.pageX-startX;if(tmp_x<=limitLienzo.x&&tmp_x>=limitLienzo.rx){x=event.pageX-startX;}
if(tmp_y<=limitLienzo.y&&tmp_y>=limitLienzo.ry){y=event.pageY-startY;}
element.css({top:y+'px',left:x+'px'});}
function getLimitLienzo(shape,sizeLabel,rotate){var limit={x:756,y:670,rx:0,ry:0};if(shape=="round"||shape=="square"){if(rotate=="0"&&shape=="round"&&sizeLabel=="small"){limit={x:774,y:690,rx:0,ry:0};console.log("small round 0");}
if(rotate=="45"&&shape=="round"&&sizeLabel=="small"){limit={x:770,y:693,rx:6,ry:0};console.log("small round 45");}
if(rotate=="0"&&shape=="square"&&sizeLabel=="small"){limit={x:774,y:692,rx:0,ry:0};console.log("small square 0");}
if(rotate=="45"&&shape=="square"&&sizeLabel=="small"){limit={x:772,y:689,rx:12,ry:0};console.log("small square 45");}
if(rotate=="45"&&sizeLabel=="medium"){limit={x:775,y:673,rx:8,ry:0};if(shape=="square"){limit={x:770,y:664,rx:17,ry:0};}
console.log("medium 45");}
if(rotate=="0"&&shape=="round"&&sizeLabel=="large"){limit={x:730,y:647,rx:0,ry:0};console.log("large round 0");}
if(rotate=="45"&&shape=="round"&&sizeLabel=="large"){limit={x:750,y:649,rx:7,ry:0};console.log("large round 45");}
if(rotate=="0"&&shape=="square"&&sizeLabel=="large"){limit={x:730,y:647,rx:0,ry:0};console.log("large square 0");}
if(rotate=="45"&&shape=="square"&&sizeLabel=="large"){limit={x:740,y:632,rx:22,ry:0};console.log("large square 0");}}else{limit={x:780,y:695,rx:0,ry:0};if(rotate=="45"&&sizeLabel=="small"){limit={x:780,y:685,rx:10,ry:0};console.log("small recta 45");}
if(rotate=="0"&&sizeLabel=="medium"){limit={x:764,y:689,rx:1,ry:0};console.log("medium recta 0");}
if(rotate=="45"&&sizeLabel=="medium"){limit={x:764,y:675,rx:10,ry:0};console.log("medium recta 45");}
if(rotate=="0"&&sizeLabel=="large"){limit={x:750,y:673,rx:1,ry:0};console.log("large recta 0");}
if(rotate=="45"&&sizeLabel=="large"){limit={x:750,y:656,rx:14,ry:5};console.log("large recta 45");}}
return limit;}
function mouseup(){$document.unbind('mousemove',mousemove);$document.unbind('mouseup',mouseup);}}
return{link:makeDraggable,scope:{onClickFn:'&'}};});angular.module('zone.service',[]).factory('ZoneFactory',function($http,ApiUrl){return{getZones:function(vData){return $http.get(ApiUrl+"/zone");},getZone:function(vId){return $http.get(ApiUrl+"/zone/"+vId);},createZone:function(vData){return $http.post(ApiUrl+'/zone',vData);},editZone:function(vData){return $http.put(ApiUrl+'/zone',vData);},deleteZone:function(vId){return $http.delete(ApiUrl+'/zone/'+vId);}};}).factory('ZoneLienzoFactory',function(){return{activarTablesItems:function(boxTables){boxTables.item=false;boxTables.items=true;angular.element('.item-drag-table').removeClass('selected-table');},updateHeaderZone:function(headerZone,itemTables){headerZone.tables=itemTables.length;var minCovers=0;var maxCovers=0;angular.forEach(itemTables,function(data){minCovers+=parseInt(data.minCover);maxCovers+=parseInt(data.maxCover);});headerZone.minCovers=minCovers;headerZone.maxCovers=maxCovers;}}}).factory('TableFactory',function(){return{getIdShape:function(label){var id="";switch(label){case"round":id="1";break;case"square":id="2";break;case"recta":id="3";break;}
return id;},getIdSize:function(label){var id="";switch(label){case"small":id="1";break;case"medium":id="2";break;case"large":id="3";break;}
return id;},getLabelShape:function(id){var label="";switch(id){case 1:label="round";break;case 2:label="square";break;case 3:label="recta";break;}
return label;},getLabelSize:function(id){var label="";switch(id){case 1:label="small";break;case 2:label="medium";break;case 3:label="large";break;}
return label;}}});angular.module('bookersnap',['tables.app']);